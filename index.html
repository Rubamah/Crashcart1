<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crash Cart Tracker</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0A1024;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --text:#EAF0FF;
      --muted:#A9B4D6;
      --muted2:#7E8AB5;

      --blue:#7DD3FC;
      --blue2:#38BDF8;
      --violet:#A78BFA;

      --green:#22C55E;
      --red:#EF4444;
      --amber:#F59E0B;
      --gray:#94A3B8;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(56,189,248,.25), transparent 55%),
        radial-gradient(1000px 520px at 100% 10%, rgba(167,139,250,.22), transparent 55%),
        radial-gradient(900px 520px at 40% 110%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(7,10,18,.82), rgba(7,10,18,.55));
      border-bottom: 1px solid var(--stroke);
    }
    .topbar{
      max-width:1200px; margin:0 auto;
      padding:14px 18px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(125,211,252,.9), transparent 70%),
        radial-gradient(18px 18px at 70% 70%, rgba(167,139,250,.85), transparent 70%),
        linear-gradient(145deg, rgba(56,189,248,.35), rgba(167,139,250,.28));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.4px;
      font-weight:800;
    }
    .brand .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .tabs{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      padding:6px; border-radius: 999px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .tab{
      appearance:none; border:0; cursor:pointer;
      background: transparent;
      color: var(--muted);
      padding:10px 14px;
      border-radius: 999px;
      font-weight:700;
      letter-spacing:.2px;
      transition: .2s ease;
      white-space: nowrap;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(180deg, rgba(125,211,252,.18), rgba(56,189,248,.10));
      box-shadow: inset 0 0 0 1px rgba(125,211,252,.25);
    }

    .actions{
      display:flex; gap:8px; align-items:center;
      min-width: 220px; justify-content:flex-end;
    }
    .btn{
      appearance:none; border:1px solid var(--stroke); cursor:pointer;
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:700;
      letter-spacing:.2px;
      transition: .18s ease;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--stroke2); }
    .btn.primary{
      border-color: rgba(125,211,252,.28);
      background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(56,189,248,.08));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.28);
      background: linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.06));
    }

    main{ max-width:1200px; margin:0 auto; padding:18px; }

    
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1.2fr .8fr; }
    }

    
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--stroke);
      margin-bottom: 12px;
    }
    .title{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.25px;
    }
    .hint{
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }

    
    .sectionLabel{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin:12px 0 8px;}
    .sectionLabel .pill{
      font-size:11px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      color: var(--muted);
      background: rgba(255,255,255,.05);
    }
    .checkline{
      display:flex; align-items:center; gap:10px;
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
      max-width: 100%;
      white-space: normal;
    }
    .checkline input[type="checkbox"]{
      width:18px; height:18px;
      flex: 0 0 auto;
      accent-color: var(--blue2);
    }
    .checkline span{ display:block; }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 720px){
      .formGrid.two{ grid-template-columns: 1fr 1fr; }
      .formGrid.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 0 0 6px;
      letter-spacing:.15px;
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(7,10,18,.55);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    input::placeholder{ color: rgba(169,180,214,.55); }
    input:focus, select:focus{
      border-color: rgba(125,211,252,.38);
      box-shadow: 0 0 0 4px rgba(56,189,248,.12), inset 0 0 0 1px rgba(255,255,255,.03);
    }

    .mono{ font-family: var(--mono); letter-spacing:.2px; }

    .rowActions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding-top: 10px;
      border-top: 1px solid var(--stroke);
      margin-top: 12px;
    }

    
    .alertsList{
      display:flex; flex-direction:column; gap:8px;
      margin-top: 10px;
    }
    .alertItem{
      border:1px solid var(--stroke);
      background: rgba(7,10,18,.45);
      border-radius: 14px;
      padding:10px 10px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      margin-top:4px;
      background: var(--gray);
      box-shadow: 0 0 0 4px rgba(148,163,184,.12);
      flex: 0 0 auto;
    }
    .dot.red{ background: var(--red); box-shadow: 0 0 0 4px rgba(239,68,68,.12); }
    .dot.amber{ background: var(--amber); box-shadow: 0 0 0 4px rgba(245,158,11,.12); }
    .alertText{
      font-size:12px;
      line-height:1.35;
      color: var(--text);
    }
    .alertMeta{
      font-size:11px;
      color: var(--muted2);
      margin-top:2px;
    }

    
    .filters{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (min-width: 900px){
      .filters{ grid-template-columns: repeat(4, 1fr); }
    }
    .filters .span2{ grid-column: span 2; }
    .filters .span4{ grid-column: span 4; }

    .tableWrap{
      margin-top:12px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      overflow:auto;
      background: rgba(7,10,18,.35);
      box-shadow: var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; min-width: 1100px; }
    thead th{
      position: sticky; top:0;
      background: rgba(7,10,18,.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--stroke2);
      padding: 12px 10px;
      font-size: 12px;
      color: var(--muted);
      text-align:left;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 11px 10px;
      font-size: 12px;
      color: var(--text);
      white-space:nowrap;
    }
    tbody tr:hover td{ background: rgba(56,189,248,.05); }

    .ccPill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 7px 10px;
      border-radius: 999px;
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing:.3px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
    }
    
    .cc-green{ color: var(--green); border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.08); }
    .cc-gray{  color: var(--gray);  border-color: rgba(148,163,184,.22); background: rgba(148,163,184,.08); }
    .cc-amber{ color: var(--amber); border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.10); }
    .cc-red{   color: var(--red);   border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10); }

    .reportFooter{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      margin-top: 12px;
    }
    .smallMuted{ font-size:12px; color: var(--muted); }
    .pager{
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
    }
    .badge b{ color: var(--text); }

    .hidden{ display:none !important; }

    
    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(7,10,18,.92);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: 999px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 12px;
      display:none;
      z-index: 999;
      max-width: min(720px, 92vw);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    
    @media print{
      header, .noPrint, .toast{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card{ border:none !important; box-shadow:none !important; background:#fff !important; }
      .tableWrap{ border:none !important; box-shadow:none !important; }
      thead th{ position: static !important; background:#fff !important; color:#000 !important; border-bottom:1px solid #ddd !important; }
      tbody td{ color:#000 !important; border-bottom:1px solid #eee !important; }
      .ccPill{ border:1px solid #ddd !important; background:#fff !important; }
      .cc-green,.cc-gray,.cc-amber,.cc-red{ color:#000 !important; }
      table{ min-width: 0 !important; }
      tr, td, th { break-inside: avoid; }
    }
  </style>
</head>

<body>
<header class="noPrint">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Crash Cart Tracker</h1>
        <p class="sub">Scan/Type crash & badges</p>
      </div>
    </div>

    
    <div class="tabs" aria-label="Cart tabs">
      <button class="tab active" id="cartCrash" type="button">Crash Cart</button>
      <button class="tab" id="cartAna" type="button">Anaphylactic cart</button>
      <button class="tab" id="cartCode" type="button">Code blue box</button>
    </div>

    
    <div class="tabs" aria-label="View tabs">
      <button class="tab active" id="tabEntry" type="button">Entry</button>
      <button class="tab" id="tabReport" type="button">Report</button>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnPrint" type="button">Print</button>
      <button class="btn danger" id="btnWipe" type="button">Wipe All</button>
    </div>
  </div>
</header>

<main>
  
  <section id="viewEntry">
    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2 class="title">Entry</h2>
            <p class="hint"></p>
          </div>
          <div class="sectionLabel"></div>
        </div>

        
        <div class="formGrid three">
          <div>
            <label for="nurseLocation">Nurse Location</label>
            <input id="nurseLocation" list="locationList" placeholder="Type location…" autocomplete="off" />
          </div>
          <div>
            <label for="pharmacistBadge">Pharmacist Badge</label>
            <input id="pharmacistBadge" class="mono" placeholder="Scan or type badge…" />
          </div>
          <div>
            <label for="nurseBadge">Nurse Badge</label>
            <input id="nurseBadge" class="mono" placeholder="Scan or type badge…" />
          </div>
        </div>

        <div class="sectionLabel">
          <div class="pill">Exchange</div>
          <label style="display:flex;gap:10px;align-items:center;margin:0;">
            <input type="checkbox" id="noCrashSent" />
            
          </label>
        </div>

        
        <div class="formGrid two">
          
          <div class="card" style="margin:0; box-shadow:none;">
            <div class="cardHeader" style="margin-bottom:10px;">
              <div>
                <h2 class="title">Sent</h2>
                <p class="hint"></p>
              </div>
            </div>

            <div class="formGrid">
              <div>
                <label for="sentCrashCart">Sent Crash Cart</label>
                <input id="sentCrashCart" class="mono" placeholder="Scan or type sent crash cart…" />
              </div>

              <div>
                <label for="medExpiryRow">Medication + Expiry</label>
                <div class="formGrid two" style="gap:10px">
                  <select id="firstMedication" aria-label="First medication to expire">
                    <option value="">Select medication…</option>
                    <option>Amiodarone 150mg/3ml</option>
                    <option>Epinephrine 1mg/10m(0.1g/ml)</option>
                    <option>Epinephrine 1mg/mL</option>
                    <option>Adenosine 6 mg/2ml</option>
                    <option>Calcium Chloride 10%</option>
                    <option>Sodium Bicarbonate 4.2g/50ml</option>
                    <option>Dextrose 50%</option>
                    <option>Lidocaine 2% (100mg/5ml)</option>
                    <option>Atropine 1mg/10ml</option>
                    <option>Atropine 500mcg or 600mcg/ml</option>
                    <option>Water for Injection</option>
                  </select>

                  <input id="expiryDate" type="date" aria-label="Expiry date for selected medication" />
                </div>
              </div>
            </div>
          </div>

          
          <div class="card" style="margin:0; box-shadow:none;">
            <div class="cardHeader" style="margin-bottom:10px;">
              <div>
                <h2 class="title">Return</h2>
                <p class="hint">.</p>
              </div>
            </div>

            <div class="formGrid">
              <div>
                <label for="returnCrashCart">Return Crash Cart</label>
                <input id="returnCrashCart" class="mono" placeholder="Scan or type return crash cart…" />
              </div>
              <div>
                <label for="returnReason">Return Reason</label>
                <select id="returnReason">
                  <option value="">Select…</option>
                  <option value="used">Used</option>
                  <option value="expired">Expired</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="rowActions noPrint">
          <button class="btn" id="btnRefresh" type="button">Refresh</button>
          <button class="btn" id="btnClear" type="button">Clear</button>
          <button class="btn primary" id="btnSave" type="button">Save</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <h2 class="title">Expiry Alerts</h2>
            <p class="hint">Based on latest status per crash cart: <b>Orange ≤30 days</b>, <b>Red ≤7 days</b>, <b>Expired (today or earlier)</b>.</p>
          </div>
          <div class="sectionLabel">
            <span class="pill">Auto-updated</span>
          </div>
        </div>

        <div class="alertsList" id="alertsList"></div>
      </div>
    </div>
  </section>

  
  <section id="viewReport" class="hidden">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2 class="title">Report</h2>
          <p class="hint">This report is for the selected tab only. Color appears <b>only</b> on the Crash Cart number.</p>
        </div>
        <div class="sectionLabel">
          <span class="pill">20 per page</span>
        </div>
      </div>

      <div class="noPrint">
        <div class="filters">
          <div>
            <label for="fCrash">Crash Cart</label>
            <input id="fCrash" class="mono" placeholder="e.g. 24" />
          </div>

          <div>
            <label for="fAction">Type</label>
            <select id="fAction">
              <option value="">All</option>
              <option value="sent">Sent</option>
              <option value="return">Return</option>
            </select>
          </div>

          <div>
            <label for="fLocation">Location</label>
            <input id="fLocation" placeholder="Type to filter…" autocomplete="off" />
          </div>

          <div>
            <label for="fBadge">Badge (any)</label>
            <input id="fBadge" class="mono" placeholder="badge number" />
          </div>

          <div>
            <label for="fReturnReason">Return Reason</label>
            <select id="fReturnReason">
              <option value="">All</option>
              <option value="used">Used</option>
              <option value="expired">Expired</option>
            </select>
          </div>

          <div>
            <label for="fMedication">Medication</label>
            <select id="fMedication">
              <option value="">All</option>
              <option>Amiodarone 150mg/3ml</option>
              <option>Epinephrine 1mg/10m(0.1g/ml)</option>
              <option>Epinephrine 1mg/mL</option>
              <option>Adenosine 6 mg/2ml</option>
              <option>Calcium Chloride 10%</option>
              <option>Sodium Bicarbonate 4.2g/50ml</option>
              <option>Dextrose 50%</option>
              <option>Lidocaine 2% (100mg/5ml)</option>
              <option>Atropine 1mg/10ml</option>
              <option>Atropine 500mcg or 600mcg/ml</option>
              <option>Water for Injection</option>
            </select>
          </div>

          <div>
            <label for="fExpiryOn">Medication Expiry (on)</label>
            <input id="fExpiryOn" type="date" />
          </div>

          <div>
            <label for="fExpiryStatus">Expiry Status</label>
            <select id="fExpiryStatus">
              <option value="">All</option>
              <option value="expired">Expired (≤0d)</option>
              <option value="red">Red (≤7d)</option>
              <option value="amber">Orange (≤30d)</option>
              <option value="notsoon">Not Soon (&gt;30d)</option>
            </select>
          </div>

          <div>
            <label for="fFrom">Record Date From</label>
            <input id="fFrom" type="date" />
          </div>

          <div>
            <label for="fTo">Record Date To</label>
            <input id="fTo" type="date" />
          </div>

          <div>
            <label for="pageSize">Rows / page</label>
            <select id="pageSize">
              <option value="20" selected>20</option>
              <option value="10">10</option>
              <option value="50">50</option>
            </select>
          </div>

          <div class="span4" style="display:flex; gap:10px; justify-content:flex-end; align-items:end;">
            <button class="btn" id="btnRefreshReport" type="button">Refresh</button>
            <button class="btn" id="btnResetFilters" type="button">Reset Filters</button>
            <button class="btn primary" id="btnPrintReport" type="button">Print Report</button>
            <button class="btn" id="btnExportCsv" type="button">Export CSV</button>
          </div>
        </div>

        <div class="reportFooter" style="margin-top:12px;">
          <div class="badge"><span class="dot" style="width:8px;height:8px"></span>Available (Return): <b id="sumAvailable">0</b></div>
          <div class="badge"><span class="dot" style="width:8px;height:8px;background:var(--gray);box-shadow:0 0 0 4px rgba(148,163,184,.12)"></span>Sent: <b id="sumSent">0</b></div>
          <div class="badge"><span class="dot amber" style="width:8px;height:8px"></span>Orange (≤30d): <b id="sumAmber">0</b></div>
          <div class="badge"><span class="dot red" style="width:8px;height:8px"></span>Red/Expired (≤7d): <b id="sumRed">0</b></div>
          <div class="smallMuted" id="resultCount">0 results</div>
        </div>
      </div>

      <div class="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th data-key="timestamp">Date/Time</th>
              <th data-key="crashNumber">Crash Cart</th>
              <th data-key="action">Type</th>
              <th data-key="location">Location</th>
              <th data-key="pharmacistBadge">Pharmacist</th>
              <th data-key="nurseBadge">Nurse</th>
              <th data-key="firstMedication">Medication</th>
              <th data-key="expiryDate">Medication Expiry</th>
              <th data-key="returnReason">Return Reason</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="reportFooter noPrint">
        <div class="smallMuted" id="pageMeta">Page 1</div>
        <div class="pager">
          <button class="btn" id="btnPrev" type="button">Prev</button>
          <span class="badge">Page <b id="pageLabel">1</b></span>
          <button class="btn" id="btnNext" type="button">Next</button>
        </div>
      </div>
    </div>
  </section>

  
  <datalist id="locationList">
    <option value="Emergency Department"></option>
    <option value="CSSD"></option>
    <option value="1"></option><option value="2"></option><option value="3"></option><option value="4"></option>
    <option value="5"></option><option value="6"></option><option value="7"></option><option value="8"></option>
    <option value="9"></option>
    <option value="10 PEDIA"></option>
    <option value="10 ADULT"></option>
    <option value="AMU"></option>
    <option value="11"></option><option value="12"></option><option value="13"></option>
    <option value="14"></option><option value="14-A ROYAL"></option><option value="14-B ROYAL"></option>
    <option value="15"></option><option value="16"></option><option value="17"></option>
    <option value="18 ROYAL"></option>
    <option value="20"></option><option value="22"></option><option value="23"></option><option value="24"></option><option value="25"></option>
    <option value="L&D"></option>
    <option value="MFMU"></option>
    <option value="ICU1"></option><option value="ICU2"></option><option value="ICU3"></option><option value="ICU4"></option>
    <option value="BU"></option>
    <option value="MAIN - OR"></option>
    <option value="MAIN - RR"></option>
    <option value="Endoscopy"></option>
    <option value="DSU"></option>
    <option value="Neuroscience and Trauma Care Center"></option>
    <option value="Ward 28 (TICU)"></option>
    <option value="Ward 40 (Station 1)"></option>
    <option value="Ward 40 (Station 2)"></option>
    <option value="Ward 41 (Station 1)"></option>
    <option value="Ward 41 (Station 2)"></option>
    <option value="KFCC Center"></option>
    <option value="C26 Surgical"></option>
    <option value="C26 Cardiology"></option>
    <option value="PCICU"></option>
    <option value="C27"></option>
    <option value="ACICU"></option>
    <option value="MCCU - CCU"></option>
    <option value="Cathlab / Cardiac Day"></option>
    <option value="Cardiac - OR"></option>
    <option value="Cardiac - RR"></option>
  </datalist>
</main>

<div class="toast noPrint" id="toast"></div>


<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC4wEKzPhnvXv-oIoMchxnGFMXxx4YYQws",
    authDomain: "crash-cart-aff89.firebaseapp.com",
    databaseURL: "https://crash-cart-aff89-default-rtdb.firebaseio.com",
    projectId: "crash-cart-aff89",
    storageBucket: "crash-cart-aff89.firebasestorage.app",
    messagingSenderId: "1039772978964",
    appId: "1:1039772978964:web:1593628f5198dab33c7c01"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const auth = getAuth(app);
  try{ await signInAnonymously(auth); }
  catch(e){ console.error("Anonymous auth failed:", e); }

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=> t.style.display="none", 2300);
  }

  function digitsOnly(s){
    return (s || "").match(/\d+/g)?.join("") || "";
  }

  function isoNow(){
    return new Date().toISOString();
  }

  function yyyyMmDd(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const da = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function startOfToday(){
    const t = new Date();
    t.setHours(0,0,0,0);
    return t;
  }

  function daysUntil(dateStr){
    const today = startOfToday();
    const d = new Date(dateStr);
    d.setHours(0,0,0,0);
    return Math.round((d - today) / 86400000);
  }

  // Expired: today or earlier.
  const ALERT_RED_DAYS = 7;
  const ALERT_ORANGE_DAYS = 30;

  function expiryStateForSent(expiryDate){
    if(!expiryDate) return "none";
    const dd = daysUntil(expiryDate);
    if(dd <= 0) return "expired";          // ✅ today counts as expired
    if(dd <= ALERT_RED_DAYS) return "red"; // ≤7
    if(dd <= ALERT_ORANGE_DAYS) return "orange"; // ≤30
    return "notsoon";
  }

  function formatDateTime(iso){
    const d = new Date(iso);
    return d.toLocaleString([], {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  /********************
   * Cart tabs (separate paths)
   ********************/
  const CARTS = [
    { key:"crashCart",        btn:"cartCrash", label:"Crash Cart",        short:"Crash",        root:"crashCart" },
    { key:"anaphylacticCart", btn:"cartAna",   label:"Anaphylactic cart", short:"Anaphylactic", root:"anaphylacticCart" },
    { key:"codeBlueBox",      btn:"cartCode",  label:"Code blue box",     short:"Code blue",    root:"codeBlueBox" }
  ];

  let activeCartKey = localStorage.getItem("cc_active_cart") || "crashCart";
  if(!CARTS.some(c=>c.key===activeCartKey)) activeCartKey = "crashCart";

  function activeCart(){
    return CARTS.find(c=>c.key===activeCartKey) || CARTS[0];
  }

  const entryTitle  = $("entryTitle");
  const reportTitle = $("reportTitle");

  function applyTabUI(){
    CARTS.forEach(c=>{
      const b = $(c.btn);
      if(b) b.classList.toggle("active", c.key===activeCartKey);
    });
    entryTitle.textContent  = `Entry (${activeCart().key})`;
    reportTitle.textContent = `Report (${activeCart().key})`;
  }

  /********************
   * Entry/Report tabs
   ********************/
  const tabEntry = $("tabEntry");
  const tabReport = $("tabReport");
  const viewEntry = $("viewEntry");
  const viewReport = $("viewReport");

  let activeView = localStorage.getItem("cc_active_view") || "entry";

  function showEntry(){
    activeView = "entry";
    localStorage.setItem("cc_active_view", activeView);
    tabEntry.classList.add("active");
    tabReport.classList.remove("active");
    viewEntry.classList.remove("hidden");
    viewReport.classList.add("hidden");
  }
  function showReport(){
    activeView = "report";
    localStorage.setItem("cc_active_view", activeView);
    tabReport.classList.add("active");
    tabEntry.classList.remove("active");
    viewReport.classList.remove("hidden");
    viewEntry.classList.add("hidden");
    applyFiltersAndRender();
  }
  tabEntry.addEventListener("click", showEntry);
  tabReport.addEventListener("click", showReport);

  /********************
   * Firebase live rows per cart
   ********************/
  let ALL_ROWS = [];
  let unsub = null;

  function logsPath(){
    return `${activeCart().root}/logs`;
  }

  function subscribe(){
    if(unsub) { try{ unsub(); }catch(_){} unsub=null; }
    ALL_ROWS = [];
    renderAlerts();
    applyFiltersAndRender();

    unsub = onValue(ref(db, logsPath()), snap=>{
      const data = snap.val() || {};
      const rows = Object.entries(data).map(([k,v]) => ({ _key:k, ...v }));
      rows.sort((a,b)=> (b.timestamp||"").localeCompare(a.timestamp||""));
      ALL_ROWS = rows;
      renderAlerts();
      applyFiltersAndRender();
    }, err=>{
      console.error("Firebase onValue error:", err);
      toast("Firebase read failed. Check rules/network.");
    });
  }

  async function addLog(record){
    const newRef = push(ref(db, logsPath()));
    await set(newRef, record);
  }

  async function wipeAll(){
    await remove(ref(db, logsPath()));
  }

  function setCart(key){
    if(!CARTS.some(c=>c.key===key)) return;
    activeCartKey = key;
    localStorage.setItem("cc_active_cart", activeCartKey);
    page = 1;
    applyTabUI();
    subscribe();
  }

  CARTS.forEach(c=>{
    const b = $(c.btn);
    if(b) b.addEventListener("click", ()=> setCart(c.key));
  });

  /********************
   * Entry: Exchange (one Save)
   ********************/
  const nurseLocation = $("nurseLocation");
  const pharmacistBadge = $("pharmacistBadge");
  const nurseBadge = $("nurseBadge");

  const sentCrashCart = $("sentCrashCart");
  const firstMedication = $("firstMedication");
  const expiryDate = $("expiryDate");

  const returnCrashCart = $("returnCrashCart");
  const returnReason = $("returnReason");

  const noCrashSent = $("noCrashSent"); // checkbox (text intentionally blank)

function applyNoSentToggle(){
  const on = !!noCrashSent.checked;
  $("sentCrashCart").disabled = on;
  $("firstMedication").disabled = on;
  $("expiryDate").disabled = on;
  if(on){
    $("sentCrashCart").value = "";
    $("firstMedication").value = "";
    $("expiryDate").value = "";
  }
}
noCrashSent.addEventListener("change", ()=>{
  applyNoSentToggle();
});

  // badge+cart numbers digits-only
  [pharmacistBadge, nurseBadge, sentCrashCart, returnCrashCart].forEach(el=>{
    el.addEventListener("blur", ()=>{ el.value = digitsOnly(el.value); });
    el.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); el.value = digitsOnly(el.value); }
    });
  });

  function clearEntry(){
    nurseLocation.value = "";
    pharmacistBadge.value = "";
    nurseBadge.value = "";
    noCrashSent.checked = false;

    sentCrashCart.value = "";
    firstMedication.value = "";
    expiryDate.value = "";

    returnCrashCart.value = "";
    returnReason.value = "";
  }

  $("btnRefresh").addEventListener("click", ()=>{
    // Hard refresh of ENTRY inputs (no page reload)
    clearEntry();
    toast("Refreshed.");
  });

  $("btnClear").addEventListener("click", ()=>{
    clearEntry();
    toast("Cleared.");
  });

  function validateExchange(){
    const loc = nurseLocation.value.trim();
    const pb = digitsOnly(pharmacistBadge.value);
    const nb = digitsOnly(nurseBadge.value);

    if(!loc) return "Nurse Location is required.";
    if(!pb) return "Pharmacist Badge is required.";
    if(!nb) return "Nurse Badge is required.";

    // Sent always required
    const sent = digitsOnly(sentCrashCart.value);
    if(!sent) return "Sent Crash Cart is required.";
    if(!firstMedication.value) return "Medication is required.";
    if(!expiryDate.value) return "Medication Expiry is required.";

    // Return crash required unless checkbox is enabled
    const ret = digitsOnly(returnCrashCart.value);
    if(!noCrashSent.checked && !ret) return "Return Crash Cart is required.";

    // Return reason always required
    if(!returnReason.value) return "Return Reason is required.";

    return "";
  }

  $("btnSave").addEventListener("click", async ()=>{
    const err = validateExchange();
    if(err){ toast(err); return; }

    const record = {
      timestamp: isoNow(),
      cartType: activeCartKey,

      nurseLocation: nurseLocation.value.trim(),
      pharmacistBadge: digitsOnly(pharmacistBadge.value),
      nurseBadge: digitsOnly(nurseBadge.value),

      sentCrashCart: digitsOnly(sentCrashCart.value),
      firstMedication: firstMedication.value,
      expiryDate: expiryDate.value,

      returnCrashCart: noCrashSent.checked ? "" : digitsOnly(returnCrashCart.value),
      returnReason: returnReason.value,

      noCrashSentInReturn: !!noCrashSent.checked
    };

    try{
      await addLog(record);
      toast("Saved.");
      clearEntry();
    } catch(e){
      console.error(e);
      toast("Save failed. Check Firebase rules/network.");
    }
  });

  /********************
   * Alerts (per tab only, based on latest per sentCrashCart)
   ********************/
  function latestBySentCart(rows){
    const map = new Map();
    for(const r of rows){
      const k = r.sentCrashCart || "";
      if(!k) continue;
      if(!map.has(k)) map.set(k, r);
    }
    return [...map.values()];
  }

  function renderAlerts(){
    const latest = latestBySentCart(ALL_ROWS);
    const alerts = [];

    for(const r of latest){
      const st = expiryStateForSent(r.expiryDate);
      if(st === "expired"){
        alerts.push({
          type: "red",
          title: `${activeCart().short} ${r.sentCrashCart} — EXPIRED`,
          meta: `${r.firstMedication} • ${r.expiryDate} • sent to ${r.nurseLocation}`
        });
      } else if(st === "red"){
        const dd = daysUntil(r.expiryDate);
        alerts.push({
          type: "red",
          title: `${activeCart().short} ${r.sentCrashCart} — ${dd} day(s) left`,
          meta: `${r.firstMedication} • ${r.expiryDate} • sent to ${r.nurseLocation}`
        });
      } else if(st === "orange"){
        const dd = daysUntil(r.expiryDate);
        alerts.push({
          type: "amber",
          title: `${activeCart().short} ${r.sentCrashCart} — ${dd} day(s) left`,
          meta: `${r.firstMedication} • ${r.expiryDate} • sent to ${r.nurseLocation}`
        });
      }
    }

    const box = $("alertsList");
    if(!alerts.length){
      box.innerHTML = `<div class="hint">No expiry alerts.</div>`;
      return;
    }

    box.innerHTML = alerts.slice(0,24).map(a=>`
      <div class="alertItem">
        <span class="dot ${a.type}"></span>
        <div>
          <div class="alertText"><b>${escapeHtml(a.title)}</b></div>
          <div class="alertMeta">${escapeHtml(a.meta)}</div>
        </div>
      </div>
    `).join("");
  }

  /********************
   * Report: filters/sort/paging (per tab only)
   ********************/
  const filters = {
    crash: $("fCrash"),          // we use this as Sent Crash Cart
    location: $("fLocation"),
    badgeAny: $("fBadge"),
    returnReason: $("fReturnReason"),
    medication: $("fMedication"),
    expiryOn: $("fExpiryOn"),
    expiryStatus: $("fExpiryStatus"),
    from: $("fFrom"),
    to: $("fTo"),
    pageSize: $("pageSize")
  };

  let sortKey = "timestamp";
  let sortDir = "desc";
  let page = 1;

  function matchText(hay, needle){
    if(!needle) return true;
    return (hay || "").toLowerCase().includes(needle.toLowerCase());
  }

  function inDateRange(iso, fromDate, toDate){
    if(!fromDate && !toDate) return true;
    const d = yyyyMmDd(iso);
    if(fromDate && d < fromDate) return false;
    if(toDate && d > toDate) return false;
    return true;
  }

  function applyFilters(rows){
    const fCrash = (filters.crash?.value || "").trim();
    const fLoc = (filters.location?.value || "").trim();
    const fBadge = digitsOnly((filters.badgeAny?.value || "").trim());
    const fRet = (filters.returnReason?.value || "");
    const fMed = (filters.medication?.value || "");
    const fExpOn = (filters.expiryOn?.value || "");
    const fExpSt = (filters.expiryStatus?.value || "");
    const fFrom = (filters.from?.value || "");
    const fTo = (filters.to?.value || "");

    return rows.filter(r=>{
      if(fCrash && !matchText(r.sentCrashCart, fCrash)) return false;
      if(fLoc && !matchText(r.nurseLocation, fLoc)) return false;

      if(fBadge){
        const b1 = digitsOnly(r.pharmacistBadge);
        const b2 = digitsOnly(r.nurseBadge);
        if(!matchText(b1, fBadge) && !matchText(b2, fBadge)) return false;
      }

      if(fRet && r.returnReason !== fRet) return false;
      if(fMed && r.firstMedication !== fMed) return false;
      if(fExpOn && r.expiryDate !== fExpOn) return false;

      if(fExpSt){
        const st = expiryStateForSent(r.expiryDate);
        if(fExpSt === "expired" && st !== "expired") return false;
        if(fExpSt === "soon" && st !== "red") return false;      // existing option "soon" maps to ≤7 (red)
        if(fExpSt === "notsoon" && st !== "notsoon") return false;
      }

      if(!inDateRange(r.timestamp, fFrom, fTo)) return false;

      return true;
    });
  }

  function sortRows(rows){
    const dir = sortDir === "asc" ? 1 : -1;

    const getVal = (r)=>{
      if(sortKey === "timestamp") return r.timestamp || "";
      if(sortKey === "crashNumber") return r.sentCrashCart || "";
      if(sortKey === "location") return r.nurseLocation || "";
      if(sortKey === "firstMedication") return r.firstMedication || "";
      if(sortKey === "expiryDate") return r.expiryDate || "";
      if(sortKey === "badge1") return r.pharmacistBadge || "";
      if(sortKey === "badge2") return r.nurseBadge || "";
      if(sortKey === "returnReason") return r.returnReason || "";
      return "";
    };

    return [...rows].sort((a,b)=>{
      let va = getVal(a);
      let vb = getVal(b);

      if(sortKey === "crashNumber"){
        const na = parseInt(va,10); const nb = parseInt(vb,10);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return (na - nb) * dir;
      }

      if(sortKey === "expiryDate"){
        va = va || "9999-12-31";
        vb = vb || "9999-12-31";
      }

      return String(va).localeCompare(String(vb)) * dir;
    });
  }

  function crashCartColorClassForRow(r){
    const st = expiryStateForSent(r.expiryDate);
    if(st === "expired" || st === "red") return "cc-red";
    if(st === "orange") return "cc-amber"; // if css doesn't exist, it will look gray; still OK
    return "cc-gray";
  }

  function renderTable(rows){
    const size = parseInt(filters.pageSize.value,10) || 20;
    const total = rows.length;
    const pages = Math.max(1, Math.ceil(total / size));
    if(page > pages) page = pages;
    if(page < 1) page = 1;

    const start = (page - 1) * size;
    const slice = rows.slice(start, start + size);

    $("resultCount").textContent = `${total} result(s)`;
    $("pageLabel").textContent = String(page);
    $("pageMeta").textContent = `Page ${page} / ${pages}`;

    const tbody = $("tbody");
    tbody.innerHTML = slice.map(r=>{
      const ccClass = crashCartColorClassForRow(r);
      return `
        <tr>
          <td>${escapeHtml(formatDateTime(r.timestamp))}</td>
          <td><span class="ccPill ${ccClass}">${escapeHtml(r.sentCrashCart || "")}</span></td>
          <td>${escapeHtml("exchange")}</td>
          <td>${escapeHtml(r.nurseLocation || "")}</td>
          <td>${escapeHtml(r.firstMedication || "")}</td>
          <td>${escapeHtml(r.expiryDate || "")}</td>
          <td class="mono">${escapeHtml(r.pharmacistBadge || "")}</td>
          <td class="mono">${escapeHtml(r.nurseBadge || "")}</td>
          <td>${escapeHtml(r.returnReason || "")}</td>
        </tr>
      `;
    }).join("");

    $("btnPrev").disabled = page <= 1;
    $("btnNext").disabled = page >= pages;
  }

  function updateSummaryAllRows(){
    // keep existing badges, but make them sensible:
    // Available (Return) isn't meaningful here; we keep "—"
    const rows = ALL_ROWS;
    const latest = latestBySentCart(rows);

    let sent = latest.length;
    let red = 0;
    for(const r of latest){
      const st = expiryStateForSent(r.expiryDate);
      if(st === "expired" || st === "red" || st === "orange") red++;
    }

    $("sumAvailable").textContent = "—";
    $("sumSent").textContent = String(sent);
    $("sumRed").textContent = String(red);
  }

  function applyFiltersAndRender(){
    updateSummaryAllRows();
    let rows = applyFilters(ALL_ROWS);
    rows = sortRows(rows);
    renderTable(rows);
  }

  // filter events
  Object.values(filters).forEach(el=>{
    if(!el) return;
    el.addEventListener("input", ()=>{ page = 1; applyFiltersAndRender(); });
    el.addEventListener("change", ()=>{ page = 1; applyFiltersAndRender(); });
  });

  $("btnResetFilters").addEventListener("click", ()=>{
    $("fCrash").value = "";
    $("fAction").value = ""; // exists in UI; ignore
    $("fLocation").value = "";
    $("fBadge").value = "";
    $("fReturnReason").value = "";
    $("fMedication").value = "";
    $("fExpiryOn").value = "";
    $("fExpiryStatus").value = "";
    $("fFrom").value = "";
    $("fTo").value = "";
    $("pageSize").value = "20";
    sortKey = "timestamp"; sortDir = "desc";
    page = 1;
    applyFiltersAndRender();
    toast("Filters reset.");
  });

  const btnRefreshReport = $("btnRefreshReport");
  if(btnRefreshReport){
    btnRefreshReport.addEventListener("click", ()=>{
      // Hard refresh of REPORT view (no page reload)
      $("btnResetFilters").click();
      toast("Report refreshed.");
    });
  }

  // sorting clicks (keep existing keys from HTML)
  document.querySelectorAll("thead th").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.getAttribute("data-key");
      if(!key) return;
      if(sortKey === key){
        sortDir = (sortDir === "asc") ? "desc" : "asc";
      } else {
        sortKey = key;
        sortDir = (key === "timestamp") ? "desc" : "asc";
      }
      page = 1;
      applyFiltersAndRender();
    });
  });

  $("btnPrev").addEventListener("click", ()=>{ page--; applyFiltersAndRender(); });
  $("btnNext").addEventListener("click", ()=>{ page++; applyFiltersAndRender(); });

  /********************
   * Export CSV (per tab)
   ********************/
  function toCsv(rows){
    const headers = ["DateTime","NurseLocation","PharmacistBadge","NurseBadge","SentCrashCart","Medication","MedicationExpiry","ReturnCrashCart","ReturnReason","NoCrashSentInReturn"];
    const lines = [headers.join(",")];
    for(const r of rows){
      const vals = [
        formatDateTime(r.timestamp),
        r.nurseLocation || "",
        r.pharmacistBadge || "",
        r.nurseBadge || "",
        r.sentCrashCart || "",
        r.firstMedication || "",
        r.expiryDate || "",
        r.returnCrashCart || "",
        r.returnReason || "",
        r.noCrashSentInReturn ? "YES" : "NO"
      ].map(v=>{
        const s = String(v ?? "");
        return `"${s.replace(/"/g,'""')}"`;
      });
      lines.push(vals.join(","));
    }
    return lines.join("\n");
  }

  $("btnExportCsv").addEventListener("click", ()=>{
    const rows = sortRows(applyFilters(ALL_ROWS));
    const csv = toCsv(rows);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${activeCartKey}_report_${yyyyMmDd(new Date())}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("CSV exported.");
  });

  /********************
   * Print
   ********************/
  $("btnPrint").addEventListener("click", ()=> window.print());
  $("btnPrintReport").addEventListener("click", ()=> window.print());

  /********************
   * Wipe All (per-tab only)
   ********************/
  $("btnWipe").addEventListener("click", async ()=>{
    const pwd = prompt("Enter wipe password:");
    if (pwd === null) return;
    if (pwd !== "Phwipe1") { toast("Wrong password."); return; }

    const ok = confirm(`Wipe ALL data for: ${activeCart().label}? This cannot be undone.`);
    if(!ok) return;

    try{
      await wipeAll();
      toast("All data wiped.");
    } catch(e){
      console.error(e);
      toast("Wipe failed. Check Firebase rules/network.");
    }
  });

  /********************
   * Init: restore view + cart after Safari refresh
   ********************/
  applyTabUI();
  if(activeView === "report") showReport(); else showEntry();
  setCart(activeCartKey);

</script>

</body>
</html>
