<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crash Cart Tracker</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0A1024;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --text:#EAF0FF;
      --muted:#A9B4D6;
      --muted2:#7E8AB5;

      --blue:#7DD3FC;
      --blue2:#38BDF8;
      --violet:#A78BFA;

      --green:#22C55E;
      --red:#EF4444;
      --amber:#F59E0B;
      --gray:#94A3B8;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(56,189,248,.25), transparent 55%),
        radial-gradient(1000px 520px at 100% 10%, rgba(167,139,250,.22), transparent 55%),
        radial-gradient(900px 520px at 40% 110%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(7,10,18,.82), rgba(7,10,18,.55));
      border-bottom: 1px solid var(--stroke);
    }
    .topbar{
      max-width:1200px; margin:0 auto;
      padding:14px 18px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
      flex: 1 1 240px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(125,211,252,.9), transparent 70%),
        radial-gradient(18px 18px at 70% 70%, rgba(167,139,250,.85), transparent 70%),
        linear-gradient(145deg, rgba(56,189,248,.35), rgba(167,139,250,.28));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.4px;
      font-weight:800;
    }
    .brand .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .tabs{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      padding:6px; border-radius: 999px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      flex: 0 0 auto;
    }
    .tab{
      appearance:none; border:0; cursor:pointer;
      background: transparent;
      color: var(--muted);
      padding:10px 14px;
      border-radius: 999px;
      font-weight:700;
      letter-spacing:.2px;
      transition: .2s ease;
      white-space: nowrap;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(180deg, rgba(125,211,252,.18), rgba(56,189,248,.10));
      box-shadow: inset 0 0 0 1px rgba(125,211,252,.25);
    }

    .actions{
      display:flex; gap:8px; align-items:center;
      min-width: 240px; justify-content:flex-end;
      flex: 1 1 240px;
    }
    .btn{
      appearance:none; border:1px solid var(--stroke); cursor:pointer;
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:700;
      letter-spacing:.2px;
      transition: .18s ease;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--stroke2); }
    .btn.primary{
      border-color: rgba(125,211,252,.28);
      background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(56,189,248,.08));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.28);
      background: linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.06));
    }

    main{ max-width:1200px; margin:0 auto; padding:18px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1.2fr .8fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--stroke);
      margin-bottom: 12px;
    }
    .title{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.25px;
    }
    .hint{
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }

    .sectionLabel{
      display:flex; align-items:center; justify-content:space-between;
      margin: 12px 0 8px;
    }
    .sectionLabel .pill{
      font-size:11px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      color: var(--muted);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 720px){
      .formGrid.two{ grid-template-columns: 1fr 1fr; }
      .formGrid.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 0 0 6px;
      letter-spacing:.15px;
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(7,10,18,.55);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    input::placeholder{ color: rgba(169,180,214,.55); }
    input:focus, select:focus{
      border-color: rgba(125,211,252,.38);
      box-shadow: 0 0 0 4px rgba(56,189,248,.12), inset 0 0 0 1px rgba(255,255,255,.03);
    }

    .mono{ font-family: var(--mono); letter-spacing:.2px; }

    .rowActions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding-top: 10px;
      border-top: 1px solid var(--stroke);
      margin-top: 12px;
    }

    .splitCard{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 900px){
      .splitCard{ grid-template-columns: 1fr 1fr; }
    }
    .miniPanel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.35);
      border-radius: var(--radius2);
      padding: 12px;
    }
    .miniHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom: 10px;
    }
    .miniHead b{
      font-size:12px; letter-spacing:.2px;
    }

    /* Checkbox row (no label text) */
    .checkRow{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.35);
    }
    .checkRow input[type="checkbox"]{
      width:18px; height:18px;
      margin:0;
      accent-color: var(--blue2);
      flex: 0 0 auto;
    }

    /* Alerts */
    .alertsList{
      display:flex; flex-direction:column; gap:8px;
      margin-top: 10px;
    }
    .alertItem{
      border:1px solid var(--stroke);
      background: rgba(7,10,18,.45);
      border-radius: 14px;
      padding:10px 10px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      margin-top:4px;
      background: var(--gray);
      box-shadow: 0 0 0 4px rgba(148,163,184,.12);
      flex: 0 0 auto;
    }
    .dot.red{ background: var(--red); box-shadow: 0 0 0 4px rgba(239,68,68,.12); }
    .dot.amber{ background: var(--amber); box-shadow: 0 0 0 4px rgba(245,158,11,.12); }
    .alertText{
      font-size:12px;
      line-height:1.35;
      color: var(--text);
    }
    .alertMeta{
      font-size:11px;
      color: var(--muted2);
      margin-top:2px;
    }

    /* Report */
    .filters{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (min-width: 900px){
      .filters{ grid-template-columns: repeat(4, 1fr); }
    }
    .filters .span4{ grid-column: span 4; }

    .tableWrap{
      margin-top:12px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      overflow:auto;
      background: rgba(7,10,18,.35);
      box-shadow: var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; min-width: 1080px; }
    thead th{
      position: sticky; top:0;
      background: rgba(7,10,18,.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--stroke2);
      padding: 12px 10px;
      font-size: 12px;
      color: var(--muted);
      text-align:left;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 11px 10px;
      font-size: 12px;
      color: var(--text);
      white-space:nowrap;
    }
    tbody tr:hover td{ background: rgba(56,189,248,.05); }

    .ccPill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 7px 10px;
      border-radius: 999px;
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing:.3px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
    }
    .cc-green{ color: var(--green); border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.08); }
    .cc-gray{  color: var(--gray);  border-color: rgba(148,163,184,.22); background: rgba(148,163,184,.08); }
    .cc-red{   color: var(--red);   border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10); }

    .reportFooter{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      margin-top: 12px;
    }
    .smallMuted{ font-size:12px; color: var(--muted); }
    .pager{
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
    }
    .badge b{ color: var(--text); }

    .hidden{ display:none !important; }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(7,10,18,.92);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: 999px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 12px;
      display:none;
      z-index: 999;
      max-width: min(720px, 92vw);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media print{
      header, .noPrint, .toast{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card{ border:none !important; box-shadow:none !important; background:#fff !important; }
      .tableWrap{ border:none !important; box-shadow:none !important; }
      thead th{ position: static !important; background:#fff !important; color:#000 !important; border-bottom:1px solid #ddd !important; }
      tbody td{ color:#000 !important; border-bottom:1px solid #eee !important; }
      .ccPill{ border:1px solid #ddd !important; background:#fff !important; }
      .cc-green,.cc-gray,.cc-red{ color:#000 !important; }
      table{ min-width: 0 !important; }
      tr, td, th { break-inside: avoid; }
    }
  </style>
</head>

<body>
<header class="noPrint">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Crash Cart Tracker</h1>
        <p class="sub" id="subtitle">Entry (CrashCart)</p>
      </div>
    </div>

    <div class="tabs" id="cartTabs" aria-label="Cart tabs">
      <button class="tab active" data-cart="crashCart" type="button">Crash Cart</button>
      <button class="tab" data-cart="codeBlueBox" type="button">Code Blue Box</button>
      <button class="tab" data-cart="anaphylacticCart" type="button">Anaphylactic Cart</button>
    </div>

    <div class="tabs" id="viewTabs" aria-label="View tabs">
      <button class="tab active" data-view="entry" type="button">Entry</button>
      <button class="tab" data-view="report" type="button">Report</button>
    </div>

    <div class="actions">
      <button class="btn" id="btnRefresh" type="button">Refresh</button>
      <button class="btn primary" id="btnPrint" type="button">Print</button>
      <button class="btn danger" id="btnWipe" type="button">Wipe</button>
    </div>
  </div>
</header>

<main>
  <!-- ENTRY VIEW -->
  <section id="viewEntry">
    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2 class="title">Entry</h2>
            <p class="hint">Scan or type crash cart numbers and badges.</p>
          </div>
          <div class="sectionLabel">
            <span class="pill" id="storagePill">Realtime DB</span>
          </div>
        </div>

        <div class="formGrid two">
          <div>
            <label for="nurseLocation">Nurse Location</label>
            <input id="nurseLocation" list="locationList" placeholder="Type to search location…" autocomplete="off" />
          </div>
          <div class="formGrid two">
            <div>
              <label for="pharmacistBadge">Pharmacist Badge</label>
              <input id="pharmacistBadge" class="mono" placeholder="Scan or type badge…" />
            </div>
            <div>
              <label for="nurseBadge">Nurse Badge</label>
              <input id="nurseBadge" class="mono" placeholder="Scan or type badge…" />
            </div>
          </div>
        </div>

        <div class="sectionLabel">
          <span class="pill">Exchange</span>
        </div>

        <div class="splitCard">
          <!-- SENT -->
          <div class="miniPanel" id="sentPanel">
            <div class="miniHead">
              <b>Sent</b>
              <span class="pill" style="padding:6px 10px;">Required</span>
            </div>

            <div class="formGrid two">
              <div>
                <label for="sentCrash">Crash Cart (Sent)</label>
                <input id="sentCrash" class="mono" placeholder="Scan or type crash cart number…" />
              </div>
              <div>
                <label for="firstMedication">First medication to expire</label>
                <select id="firstMedication">
                  <option value="">Select…</option>
                </select>
              </div>
            </div>

            <div class="formGrid two">
              <div>
                <label for="expiryDate">Expiry Date</label>
                <input id="expiryDate" type="date" />
              </div>
              <div class="checkRow" title="No crash sent in return">
                <input id="noCrashSent" type="checkbox" />
              </div>
            </div>
          </div>

          <!-- RETURN -->
          <div class="miniPanel">
            <div class="miniHead">
              <b>Return</b>
              <span class="pill" style="padding:6px 10px;">Required</span>
            </div>

            <div class="formGrid two">
              <div>
                <label for="returnCrash">Crash Cart (Return)</label>
                <input id="returnCrash" class="mono" placeholder="Scan or type crash cart number…" />
              </div>
              <div>
                <label for="returnReason">Return Reason</label>
                <select id="returnReason">
                  <option value="">Select…</option>
                  <option value="used">Used</option>
                  <option value="expired">Expired</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="rowActions noPrint">
          <button class="btn" id="btnClear" type="button">Clear</button>
          <button class="btn primary" id="btnSave" type="button">Save</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <h2 class="title">Expiry Alerts</h2>
            <p class="hint">Orange ≤30 days • Red ≤7 days • Expired if today is the expiry date (or later).</p>
          </div>
          <div class="sectionLabel">
            <span class="pill">Auto-updated</span>
          </div>
        </div>

        <div class="alertsList" id="alertsList"></div>
      </div>
    </div>
  </section>

  <!-- REPORT VIEW -->
  <section id="viewReport" class="hidden">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2 class="title">Report</h2>
          <p class="hint">Filter, sort, and print. Color appears only on the Crash Cart number.</p>
        </div>
        <div class="sectionLabel">
          <span class="pill">20 per page</span>
        </div>
      </div>

      <div class="noPrint">
        <div class="filters">
          <div>
            <label for="fCrash">Crash Cart (any)</label>
            <input id="fCrash" class="mono" placeholder="e.g. 24" />
          </div>

          <div>
            <label for="fLocation">Location</label>
            <input id="fLocation" list="locationList" placeholder="Type to search location…" autocomplete="off" />
          </div>

          <div>
            <label for="fBadge">Badge (any)</label>
            <input id="fBadge" class="mono" placeholder="badge number" />
          </div>

          <div>
            <label for="fReturnReason">Return Reason</label>
            <select id="fReturnReason">
              <option value="">All</option>
              <option value="used">Used</option>
              <option value="expired">Expired</option>
            </select>
          </div>

          <div>
            <label for="fMedication">Medication</label>
            <select id="fMedication">
              <option value="">All</option>
            </select>
          </div>

          <div>
            <label for="fExpiryOn">Medication Expiry (on)</label>
            <input id="fExpiryOn" type="date" />
          </div>

          <div>
            <label for="fExpiryStatus">Expiry Status</label>
            <select id="fExpiryStatus">
              <option value="">All</option>
              <option value="expired">Expired</option>
              <option value="red7">Red (≤7d)</option>
              <option value="orange30">Orange (≤30d)</option>
              <option value="notsoon">Not Soon (&gt;30d)</option>
            </select>
          </div>

          <div>
            <label for="fFrom">Record Date From</label>
            <input id="fFrom" type="date" />
          </div>

          <div>
            <label for="fTo">Record Date To</label>
            <input id="fTo" type="date" />
          </div>

          <div>
            <label for="pageSize">Rows / page</label>
            <select id="pageSize">
              <option value="20" selected>20</option>
              <option value="10">10</option>
              <option value="50">50</option>
            </select>
          </div>

          <div class="span4" style="display:flex; gap:10px; justify-content:flex-end; align-items:end;">
            <button class="btn" id="btnRefreshReport" type="button">Refresh</button>
            <button class="btn" id="btnResetFilters" type="button">Reset Filters</button>
            <button class="btn primary" id="btnPrintReport" type="button">Print Report</button>
            <button class="btn" id="btnExportCsv" type="button">Export CSV</button>
          </div>
        </div>

        <div class="reportFooter" style="margin-top:12px;">
          <div class="badge"><span class="dot" style="width:8px;height:8px"></span>Available: <b id="sumAvailable">0</b></div>
          <div class="badge"><span class="dot" style="width:8px;height:8px;background:var(--gray);box-shadow:0 0 0 4px rgba(148,163,184,.12)"></span>Sent: <b id="sumSent">0</b></div>
          <div class="badge"><span class="dot red" style="width:8px;height:8px"></span>Alert: <b id="sumAlert">0</b></div>
          <div class="smallMuted" id="resultCount">0 results</div>
        </div>
      </div>

      <div class="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th data-key="timestamp">Date/Time</th>
              <th data-key="sentCrash">Crash (Sent)</th>
              <th data-key="returnCrash">Crash (Return)</th>
              <th data-key="location">Location</th>
              <th data-key="pharmacistBadge">Pharmacist</th>
              <th data-key="nurseBadge">Nurse</th>
              <th data-key="firstMedication">Medication</th>
              <th data-key="expiryDate">Medication Expiry</th>
              <th data-key="returnReason">Return Reason</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="reportFooter noPrint">
        <div class="smallMuted" id="pageMeta">Page 1</div>
        <div class="pager">
          <button class="btn" id="btnPrev" type="button">Prev</button>
          <span class="badge">Page <b id="pageLabel">1</b></span>
          <button class="btn" id="btnNext" type="button">Next</button>
        </div>
      </div>
    </div>
  </section>

  <datalist id="locationList">
    <option value="Emergency Department"></option>
    <option value="CSSD"></option>
    <option value="1"></option>
    <option value="2"></option>
    <option value="3"></option>
    <option value="4"></option>
    <option value="5"></option>
    <option value="6"></option>
    <option value="7"></option>
    <option value="8"></option>
    <option value="9"></option>
    <option value="10 PEDIA"></option>
    <option value="10 ADULT"></option>
    <option value="AMU"></option>
    <option value="11"></option>
    <option value="12"></option>
    <option value="13"></option>
    <option value="14"></option>
    <option value="14-A ROYAL"></option>
    <option value="14-B ROYAL"></option>
    <option value="15"></option>
    <option value="16"></option>
    <option value="17"></option>
    <option value="18 ROYAL"></option>
    <option value="20"></option>
    <option value="22"></option>
    <option value="23"></option>
    <option value="24"></option>
    <option value="25"></option>
    <option value="L&D"></option>
    <option value="MFMU"></option>
    <option value="ICU1"></option>
    <option value="ICU2"></option>
    <option value="ICU3"></option>
    <option value="ICU4"></option>
    <option value="BU"></option>
    <option value="MAIN - OR"></option>
    <option value="MAIN - RR"></option>
    <option value="Endoscopy"></option>
    <option value="DSU"></option>
    <option value="Neuroscience and Trauma Care Center"></option>
    <option value="Ward 28 (TICU)"></option>
    <option value="Ward 40 (Station 1)"></option>
    <option value="Ward 40 (Station 2)"></option>
    <option value="Ward 41 (Station 1)"></option>
    <option value="Ward 41 (Station 2)"></option>
    <option value="KFCC Center"></option>
    <option value="C26 Surgical"></option>
    <option value="C26 Cardiology"></option>
    <option value="PCICU"></option>
    <option value="C27"></option>
    <option value="ACICU"></option>
    <option value="MCCU - CCU"></option>
    <option value="Cathlab / Cardiac Day"></option>
    <option value="Cardiac - OR"></option>
    <option value="Cardiac - RR"></option>
  </datalist>
</main>

<div class="toast noPrint" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC4wEKzPhnvXv-oIoMchxnGFMXxx4YYQws",
    authDomain: "crash-cart-aff89.firebaseapp.com",
    databaseURL: "https://crash-cart-aff89-default-rtdb.firebaseio.com",
    projectId: "crash-cart-aff89",
    storageBucket: "crash-cart-aff89.firebasestorage.app",
    messagingSenderId: "1039772978964",
    appId: "1:1039772978964:web:1593628f5198dab33c7c01"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const CART_ROOTS = {
    crashCart: "crashCart",
    anaphylacticCart: "anaphylacticCart",
    codeBlueBox: "codeBlueBox"
  };

  function logsPath(cartKey){
    return `${CART_ROOTS[cartKey]}/logs`;
  }

  async function ensureAuth(){
    return new Promise((resolve, reject)=>{
      onAuthStateChanged(auth, async (user)=>{
        try{
          if(user) return resolve(user);
          await signInAnonymously(auth);
          resolve(auth.currentUser);
        }catch(e){ reject(e); }
      });
    });
  }

  await ensureAuth();

  window.__fb = {
    db,
    ref,
    push,
    set,
    onValue,
    remove,
    logsPath
  };
</script>

<script>
  const $ = (id)=>document.getElementById(id);

  const ALERT_RED_DAYS = 7;
  const ALERT_ORANGE_DAYS = 30;

  const MEDS_BY_CART = {
    crashCart: [
    "Amiodarone 150mg/3ml",
    "Epinephrine 1mg/10m(0.1g/ml)",
    "Epinephrine 1mg/mL",
    "Adenosine 6 mg/2ml",
    "Calcium Chloride 10%",
    "Sodium Bicarbonate 4.2g/50ml",
    "Dextrose 50%",
    "Lidocaine 2% (100mg/5ml)",
    "Atropine 1mg/10ml",
    "Atropine 500mcg or 600mcg/ml",
    "Water for Injection"
],
    codeBlueBox: [
    "Amiodarone 150mg/3ml",
    "Epinephrine 1mg/10m(0.1g/ml)",
    "Epinephrine 1mg/mL",
    "Adenosine 6 mg/2ml",
    "Calcium Chloride 10%",
    "Sodium Bicarbonate 4.2g/50ml",
    "Dextrose 50%",
    "Lidocaine 2% (100mg/5ml)",
    "Atropine 1mg/10ml",
    "Atropine 500mcg or 600mcg/ml",
    "Water for Injection"
],
    anaphylacticCart: [
    "Diphenhydramine injection 50 mg/ml",
    "Syringe 10 ml",
    "Methylprednisolone Hydrogen Succinate injection 500 mg/vial",
    "Syringe 5 ml",
    "Albuterol (Salbutamol) Nebulizer Solution 5 mg/2.5 ml",
    "Syringe 3 ml",
    "Normal Saline 500 ml I.V. bag",
    "Epinephrine injection 1 mg/ml (1:1000)",
    "Glucagon syringe 1 mg",
    "Syringe 1 ml with needle",
    "Normal Saline for injection 10 ml",
    "Needle 18 gauge 5/8",
    "IV line set",
    "Filter needle 19 gauge",
    "Hydrocortisone Sodium Succinate 50 mg/ml (2 ml) injection",
    "Alcohol swab",
    "Levetiracetam 100 mg/ml (5 ml) vial",
    "Acetaminophen 10 mg/ml (100 ml) vial",
    "Dexamethasone Sodium 4 mg/ml (2 ml) injection",
    "Naloxone HCl 0.4 mg/ml (1 ml) ampoule",
    "Flumazenil 0.1 mg/ml (5 ml) injection"
],
    codeBlueBox: [
    "Adenosine 6 mg/2 mL",
    "Etomidate 2 mg/mL",
    "Norepinephrine Bitartrate 4 mg/4 mL",
    "Sodium Bicarbonate 8.4% injection 50 mL",
    "Amiodarone 150 mg/3 mL",
    "Verapamil 5 mg/2 mL ampoule",
    "Calcium Chloride 10%",
    "Propranolol 1 mg/mL",
    "Dopamine HCl 200 mg/5 mL vial",
    "Normal Saline 10 mL",
    "Magnesium Sulfate 50% injection",
    "Dextrose 50%",
    "D5W",
    "Normal Saline 100 mL",
    "D5W 100 mL",
    "D5W 250 mL",
    "Sterile Water 10 mL",
    "Syringes",
    "Phenytoin 250 mg ampoule",
    "Lidocaine 2% 5 mL prefilled syringe",
    "Rocuronium 10 mg/mL",
    "Procainamide 100 mg/mL vial",
    "Furosemide 20 mg/2 mL ampoule",
    "Atropine 1 mg/10 mL",
    "Epinephrine HCl 1:1000",
    "Epinephrine 1:10,000 prefilled",
    "Dopamine infusion (400 mg or 800 mg in D5W)"
]
  };

  function refreshMedicationOptions(){
    const entrySel = $("firstMedication");
    const filterSel = $("fMedication");
    const meds = MEDS_BY_CART[ACTIVE_CART] || [];

    const prevEntry = entrySel ? entrySel.value : "";
    const prevFilter = filterSel ? filterSel.value : "";

    if(entrySel){
      const opts = ['<option value="">Select…</option>'].concat(
        meds.map(m => `<option>${escapeHtml(m)}</option>`)
      );
      entrySel.innerHTML = opts.join("");
      if(meds.includes(prevEntry)) entrySel.value = prevEntry;
    }

    if(filterSel){
      const opts = ['<option value="">All</option>'].concat(
        meds.map(m => `<option>${escapeHtml(m)}</option>`)
      );
      filterSel.innerHTML = opts.join("");
      if(meds.includes(prevFilter)) filterSel.value = prevFilter;
    }
  }

  let ACTIVE_CART = "crashCart";
  let ACTIVE_VIEW = "entry";
  let ALL_ROWS = [];

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=> t.style.display="none", 2300);
  }

  function digitsOnly(s){
    return (s || "").match(/\d+/g)?.join("") || "";
  }

  function isoNow(){
    return new Date().toISOString();
  }

  function yyyyMmDd(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const da = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function daysUntil(dateStr){
    const today = new Date(); today.setHours(0,0,0,0);
    const d = new Date(dateStr); d.setHours(0,0,0,0);
    return Math.round((d - today) / 86400000);
  }

  // Expired if today is the expiry date (or later) => dd <= 0
  function expiryBand(expiryDate){
    if(!expiryDate) return "none";
    const dd = daysUntil(expiryDate);
    if(dd <= 0) return "expired";
    if(dd <= ALERT_RED_DAYS) return "red7";
    if(dd <= ALERT_ORANGE_DAYS) return "orange30";
    return "notsoon";
  }

  function formatDateTime(iso){
    const d = new Date(iso);
    return d.toLocaleString([], {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function parseHash(){
    const h = location.hash.replace(/^#/, "");
    const out = {};
    if(!h) return out;
    const parts = h.split("&");
    for(const p of parts){
      const [k,v] = p.split("=");
      if(k && v) out[decodeURIComponent(k)] = decodeURIComponent(v);
    }
    return out;
  }

  function setHash(cart, view){
    const h = `cart=${encodeURIComponent(cart)}&view=${encodeURIComponent(view)}`;
    if(location.hash.replace(/^#/, "") !== h){
      history.replaceState(null, "", "#" + h);
    }
  }

  function setSubtitle(){
    const map = {
      crashCart: "CrashCart",
      codeBlueBox: "CodeBlueBox",
      anaphylacticCart: "AnaphylacticCart"
    };
    $("subtitle").textContent = (ACTIVE_VIEW === "entry" ? "Entry" : "Report") + ` (${map[ACTIVE_CART] || "CrashCart"})`;
  }

  function showEntry(){
    ACTIVE_VIEW = "entry";
    $("viewEntry").classList.remove("hidden");
    $("viewReport").classList.add("hidden");
    document.querySelectorAll("#viewTabs .tab").forEach(b=> b.classList.toggle("active", b.dataset.view === "entry"));
    setSubtitle();
    setHash(ACTIVE_CART, ACTIVE_VIEW);
  }

  function showReport(){
    ACTIVE_VIEW = "report";
    $("viewReport").classList.remove("hidden");
    $("viewEntry").classList.add("hidden");
    document.querySelectorAll("#viewTabs .tab").forEach(b=> b.classList.toggle("active", b.dataset.view === "report"));
    setSubtitle();
    setHash(ACTIVE_CART, ACTIVE_VIEW);
    applyFiltersAndRender();
  }

  function applyCart(cartKey){
    ACTIVE_CART = cartKey;
    document.querySelectorAll("#cartTabs .tab").forEach(b=> b.classList.toggle("active", b.dataset.cart === cartKey));
    setSubtitle();
    refreshMedicationOptions();
    setHash(ACTIVE_CART, ACTIVE_VIEW);
    startFirebaseListener(); // rebind
  }

  // View tab clicks
  document.querySelectorAll("#viewTabs .tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      (btn.dataset.view === "entry") ? showEntry() : showReport();
    });
  });

  // Cart tab clicks
  document.querySelectorAll("#cartTabs .tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      applyCart(btn.dataset.cart);
    });
  });

  // Refresh buttons
  $("btnRefresh").addEventListener("click", ()=>{
    // hard refresh behavior but keep cart/view
    setHash(ACTIVE_CART, ACTIVE_VIEW);
    location.reload();
  });
  $("btnRefreshReport").addEventListener("click", ()=>{
    setHash(ACTIVE_CART, ACTIVE_VIEW);
    location.reload();
  });

  /********************
   * Scan/Type rules: badges + crash numbers only
   ********************/
  ["pharmacistBadge","nurseBadge","sentCrash","returnCrash"].forEach(id=>{
    const el = $(id);
    el.addEventListener("blur", ()=> el.value = digitsOnly(el.value));
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        el.value = digitsOnly(el.value);
      }
    });
  });

  const noCrashSent = $("noCrashSent");
  function syncSentRequiredUI(){
    const disabled = noCrashSent.checked;
    $("sentPanel").style.opacity = disabled ? "0.70" : "1";
  }
  noCrashSent.addEventListener("change", syncSentRequiredUI);

  $("btnClear").addEventListener("click", ()=>{
    $("nurseLocation").value = "";
    $("pharmacistBadge").value = "";
    $("nurseBadge").value = "";
    $("sentCrash").value = "";
    $("firstMedication").value = "";
    $("expiryDate").value = "";
    $("returnCrash").value = "";
    $("returnReason").value = "";
    $("noCrashSent").checked = false;
    syncSentRequiredUI();
    toast("Cleared.");
    $("nurseLocation").focus();
  });

  function validateEntry(){
    const loc = $("nurseLocation").value.trim();
    const pharm = digitsOnly($("pharmacistBadge").value);
    const nurse = digitsOnly($("nurseBadge").value);

    if(!loc) return "Nurse Location is required.";
    if(!pharm) return "Pharmacist Badge is required.";
    if(!nurse) return "Nurse Badge is required.";

    const sentCrash = digitsOnly($("sentCrash").value);
    const med = $("firstMedication").value;
    const exp = $("expiryDate").value;

    const returnCrash = digitsOnly($("returnCrash").value);
    const retReason = $("returnReason").value;

    // Return always required
    if(!returnCrash) return "Crash Cart (Return) is required.";
    if(!retReason) return "Return Reason is required.";

    // Sent required unless checkbox checked
    if(!noCrashSent.checked){
      if(!sentCrash) return "Crash Cart (Sent) is required.";
      if(!med) return "Medication is required.";
      if(!exp) return "Expiry Date is required.";
    }

    // If checkbox checked, we still allow med/exp empty (because no sent)
    return "";
  }

  /********************
   * Firebase wiring
   ********************/
  let unsubscribe = null;

  function normalizeRowsFromSnapshot(data){
    const rows = Object.entries(data || {}).map(([k,v])=> ({ _key:k, ...v }));
    rows.sort((a,b)=> (b.timestamp||"").localeCompare(a.timestamp||""));
    return rows;
  }

  function startFirebaseListener(){
    if(!window.__fb){ toast("Firebase not loaded."); return; }

    // Rebind
    if(unsubscribe && typeof unsubscribe === "function"){ try{ unsubscribe(); }catch{} }
    const { db, ref, onValue, logsPath } = window.__fb;

    const p = logsPath(ACTIVE_CART);
    const r = ref(db, p);

    // Firebase v9+ onValue returns unsubscribe function
    unsubscribe = onValue(r, snap=>{
      ALL_ROWS = normalizeRowsFromSnapshot(snap.val() || {});
      renderAlerts();
      applyFiltersAndRender();
    }, err=>{
      console.error(err);
      toast("Save failed because rules.");
    });
  }

  async function addLog(record){
    const { db, ref, push, set, logsPath } = window.__fb;
    const p = logsPath(ACTIVE_CART);
    const newRef = push(ref(db, p));
    await set(newRef, record);
  }

  async function wipeLogsForActiveCart(){
    const { db, ref, remove, logsPath } = window.__fb;
    await remove(ref(db, logsPath(ACTIVE_CART)));
  }

  /********************
   * Save
   ********************/
  $("btnSave").addEventListener("click", async ()=>{
    const err = validateEntry();
    if(err){ toast(err); return; }

    const record = {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
      timestamp: isoNow(),
      cartKey: ACTIVE_CART,

      location: $("nurseLocation").value.trim(),
      pharmacistBadge: digitsOnly($("pharmacistBadge").value),
      nurseBadge: digitsOnly($("nurseBadge").value),

      sentCrash: digitsOnly($("sentCrash").value),
      firstMedication: $("firstMedication").value || "",
      expiryDate: $("expiryDate").value || "",

      returnCrash: digitsOnly($("returnCrash").value),
      returnReason: $("returnReason").value || "",

      noCrashSentInReturn: !!$("noCrashSent").checked
    };

    try{
      await addLog(record);
      toast("Saved.");
      $("btnClear").click();
    }catch(e){
      console.error(e);
      toast("Save failed because rules.");
    }
  });

  /********************
   * Alerts (latest state per crash cart number)
   * Status rules:
   * - If a cart number's latest appearance is in returnCrash => available (no alerts)
   * - If latest appearance is in sentCrash => sent (alerts based on expiry)
   ********************/
  function latestStateByCrash(rows){
    // rows are newest-first already
    const state = new Map(); // crashNumber => {status, row}
    for(const r of rows){
      const s = digitsOnly(r.sentCrash);
      const ret = digitsOnly(r.returnCrash);

      // Set only if not already set (newest wins)
      if(s && !state.has(s)){
        state.set(s, { status:"sent", row:r });
      }
      if(ret && !state.has(ret)){
        state.set(ret, { status:"return", row:r });
      }
    }
    return state;
  }

  function renderAlerts(){
    const rows = ALL_ROWS;
    const stMap = latestStateByCrash(rows);
    const alerts = [];

    for(const [cc, st] of stMap.entries()){
      if(st.status !== "sent") continue;

      const r = st.row;
      // Only if expiry info exists and checkbox is NOT enabled for that record
      if(!r.expiryDate || !r.firstMedication) continue;
      if(r.noCrashSentInReturn) continue;

      const band = expiryBand(r.expiryDate);
      const dd = daysUntil(r.expiryDate);

      if(band === "expired"){
        alerts.push({
          type: "red",
          title: `Crash ${cc} — EXPIRED`,
          meta: `${r.firstMedication} • ${r.expiryDate} • sent to ${r.location}`
        });
      } else if(band === "red7"){
        alerts.push({
          type: "red",
          title: `Crash ${cc} — expiring in ${dd} day(s)`,
          meta: `${r.firstMedication} • ${r.expiryDate} • sent to ${r.location}`
        });
      } else if(band === "orange30"){
        alerts.push({
          type: "amber",
          title: `Crash ${cc} — expiring in ${dd} day(s)`,
          meta: `${r.firstMedication} • ${r.expiryDate} • sent to ${r.location}`
        });
      }
    }

    // sort by soonest expiry, expired first
    alerts.sort((a,b)=>{
      const aExp = a.title.includes("EXPIRED") ? 0 : 1;
      const bExp = b.title.includes("EXPIRED") ? 0 : 1;
      if(aExp !== bExp) return aExp - bExp;
      const da = (a.meta.match(/\d{4}-\d{2}-\d{2}/)||["9999-12-31"])[0];
      const db = (b.meta.match(/\d{4}-\d{2}-\d{2}/)||["9999-12-31"])[0];
      return da.localeCompare(db);
    });

    const box = $("alertsList");
    if(!alerts.length){
      box.innerHTML = `<div class="hint">No expiry alerts.</div>`;
      return;
    }

    box.innerHTML = alerts.slice(0,24).map(a=>`
      <div class="alertItem">
        <span class="dot ${a.type === "red" ? "red" : "amber"}"></span>
        <div>
          <div class="alertText"><b>${escapeHtml(a.title)}</b></div>
          <div class="alertMeta">${escapeHtml(a.meta)}</div>
        </div>
      </div>
    `).join("");
  }

  /********************
   * Report
   ********************/
  const filters = {
    crash: $("fCrash"),
    location: $("fLocation"),
    badge: $("fBadge"),
    returnReason: $("fReturnReason"),
    medication: $("fMedication"),
    expiryOn: $("fExpiryOn"),
    expiryStatus: $("fExpiryStatus"),
    from: $("fFrom"),
    to: $("fTo"),
    pageSize: $("pageSize")
  };

  let sortKey = "timestamp";
  let sortDir = "desc";
  let page = 1;

  function matchText(hay, needle){
    if(!needle) return true;
    return (hay || "").toLowerCase().includes(needle.toLowerCase());
  }

  function inDateRange(iso, fromDate, toDate){
    if(!fromDate && !toDate) return true;
    const d = yyyyMmDd(iso);
    if(fromDate && d < fromDate) return false;
    if(toDate && d > toDate) return false;
    return true;
  }

  function applyFilters(rows){
    const fCrash = digitsOnly(filters.crash.value.trim());
    const fLoc = filters.location.value.trim();
    const fBadge = digitsOnly(filters.badge.value.trim());
    const fRet = filters.returnReason.value;
    const fMed = filters.medication.value;
    const fExpOn = filters.expiryOn.value;
    const fExpSt = filters.expiryStatus.value;
    const fFrom = filters.from.value;
    const fTo = filters.to.value;

    return rows.filter(r=>{
      const sent = digitsOnly(r.sentCrash);
      const ret = digitsOnly(r.returnCrash);

      if(fCrash){
        if(!matchText(sent, fCrash) && !matchText(ret, fCrash)) return false;
      }
      if(fLoc && !matchText(r.location, fLoc)) return false;

      if(fBadge){
        if(!matchText(digitsOnly(r.pharmacistBadge), fBadge) && !matchText(digitsOnly(r.nurseBadge), fBadge)) return false;
      }

      if(fRet && (r.returnReason !== fRet)) return false;

      if(fMed){
        if(r.firstMedication !== fMed) return false;
      }

      if(fExpOn){
        if(r.expiryDate !== fExpOn) return false;
      }

      if(fExpSt){
        const band = expiryBand(r.expiryDate);
        if(fExpSt === "expired" && band !== "expired") return false;
        if(fExpSt === "red7" && band !== "red7") return false;
        if(fExpSt === "orange30" && band !== "orange30") return false;
        if(fExpSt === "notsoon" && band !== "notsoon") return false;
      }

      if(!inDateRange(r.timestamp, fFrom, fTo)) return false;
      return true;
    });
  }

  function sortRows(rows){
    const dir = sortDir === "asc" ? 1 : -1;

    const getVal = (r)=>{
      switch(sortKey){
        case "timestamp": return r.timestamp || "";
        case "sentCrash": return digitsOnly(r.sentCrash) || "";
        case "returnCrash": return digitsOnly(r.returnCrash) || "";
        case "location": return r.location || "";
        case "pharmacistBadge": return digitsOnly(r.pharmacistBadge) || "";
        case "nurseBadge": return digitsOnly(r.nurseBadge) || "";
        case "firstMedication": return r.firstMedication || "";
        case "expiryDate": return r.expiryDate || "";
        case "returnReason": return r.returnReason || "";
        default: return "";
      }
    };

    return [...rows].sort((a,b)=>{
      let va = getVal(a);
      let vb = getVal(b);

      if(sortKey === "sentCrash" || sortKey === "returnCrash"){
        const na = parseInt(va,10); const nb = parseInt(vb,10);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return (na - nb) * dir;
      }

      if(sortKey === "expiryDate"){
        va = va || "9999-12-31";
        vb = vb || "9999-12-31";
      }

      return String(va).localeCompare(String(vb)) * dir;
    });
  }

  function crashCartColorClassForNumber(cc, stateMap){
    const st = stateMap.get(cc);
    if(!st) return "cc-gray";
    if(st.status === "return") return "cc-green";
    // sent
    const r = st.row;
    if(r && r.expiryDate && r.firstMedication && !r.noCrashSentInReturn){
      const band = expiryBand(r.expiryDate);
      if(band === "expired" || band === "red7") return "cc-red";
      if(band === "orange30") return "cc-red"; // keep red for "alert" coloring in report
    }
    return "cc-gray";
  }

  function updateSummaryAllRows(){
    const rows = ALL_ROWS;
    const stMap = latestStateByCrash(rows);

    let available = 0, sent = 0, alert = 0;

    for(const [cc, st] of stMap.entries()){
      if(st.status === "return"){
        available++;
      } else if(st.status === "sent"){
        sent++;
        const r = st.row;
        if(r && r.expiryDate && r.firstMedication && !r.noCrashSentInReturn){
          const band = expiryBand(r.expiryDate);
          if(band === "expired" || band === "red7" || band === "orange30") alert++;
        }
      }
    }

    $("sumAvailable").textContent = available;
    $("sumSent").textContent = sent;
    $("sumAlert").textContent = alert;
    return stMap;
  }

  function renderTable(rows){
    const size = parseInt(filters.pageSize.value,10) || 20;
    const total = rows.length;
    const pages = Math.max(1, Math.ceil(total / size));
    if(page > pages) page = pages;
    if(page < 1) page = 1;

    const start = (page - 1) * size;
    const slice = rows.slice(start, start + size);

    $("resultCount").textContent = `${total} result(s)`;
    $("pageLabel").textContent = String(page);
    $("pageMeta").textContent = `Page ${page} / ${pages}`;

    const stMap = latestStateByCrash(ALL_ROWS);

    const tbody = $("tbody");
    tbody.innerHTML = slice.map(r=>{
      const sent = digitsOnly(r.sentCrash);
      const ret = digitsOnly(r.returnCrash);

      const sentClass = sent ? crashCartColorClassForNumber(sent, stMap) : "cc-gray";
      const retClass = ret ? crashCartColorClassForNumber(ret, stMap) : "cc-gray";

      return `
        <tr>
          <td>${escapeHtml(formatDateTime(r.timestamp))}</td>
          <td>${sent ? `<span class="ccPill ${sentClass}">${escapeHtml(sent)}</span>` : ""}</td>
          <td>${ret ? `<span class="ccPill ${retClass}">${escapeHtml(ret)}</span>` : ""}</td>
          <td>${escapeHtml(r.location || "")}</td>
          <td class="mono">${escapeHtml(digitsOnly(r.pharmacistBadge) || "")}</td>
          <td class="mono">${escapeHtml(digitsOnly(r.nurseBadge) || "")}</td>
          <td>${escapeHtml(r.firstMedication || "")}</td>
          <td>${escapeHtml(r.expiryDate || "")}</td>
          <td>${escapeHtml(r.returnReason || "")}</td>
        </tr>
      `;
    }).join("");

    $("btnPrev").disabled = page <= 1;
    $("btnNext").disabled = page >= pages;
  }

  function applyFiltersAndRender(){
    if(ACTIVE_VIEW !== "report") return;
    updateSummaryAllRows();
    let rows = applyFilters(ALL_ROWS);
    rows = sortRows(rows);
    renderTable(rows);
  }

  // Filter listeners
  Object.values(filters).forEach(el=>{
    if(!el) return;
    el.addEventListener("input", ()=>{ page = 1; applyFiltersAndRender(); });
    el.addEventListener("change", ()=>{ page = 1; applyFiltersAndRender(); });
  });

  $("btnResetFilters").addEventListener("click", ()=>{
    $("fCrash").value = "";
    $("fLocation").value = "";
    $("fBadge").value = "";
    $("fReturnReason").value = "";
    $("fMedication").value = "";
    $("fExpiryOn").value = "";
    $("fExpiryStatus").value = "";
    $("fFrom").value = "";
    $("fTo").value = "";
    $("pageSize").value = "20";
    sortKey = "timestamp"; sortDir = "desc";
    page = 1;
    applyFiltersAndRender();
    toast("Filters reset.");
  });

  // Sorting
  document.querySelectorAll("thead th").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.getAttribute("data-key");
      if(!key) return;
      if(sortKey === key){
        sortDir = (sortDir === "asc") ? "desc" : "asc";
      } else {
        sortKey = key;
        sortDir = (key === "timestamp") ? "desc" : "asc";
      }
      page = 1;
      applyFiltersAndRender();
    });
  });

  $("btnPrev").addEventListener("click", ()=>{ page--; applyFiltersAndRender(); });
  $("btnNext").addEventListener("click", ()=>{ page++; applyFiltersAndRender(); });

  // Export CSV
  function toCsv(rows){
    const headers = ["DateTime","Location","PharmacistBadge","NurseBadge","SentCrash","ReturnCrash","Medication","MedicationExpiry","ReturnReason","NoCrashSentInReturn"];
    const lines = [headers.join(",")];
    for(const r of rows){
      const vals = [
        formatDateTime(r.timestamp),
        r.location || "",
        digitsOnly(r.pharmacistBadge) || "",
        digitsOnly(r.nurseBadge) || "",
        digitsOnly(r.sentCrash) || "",
        digitsOnly(r.returnCrash) || "",
        r.firstMedication || "",
        r.expiryDate || "",
        r.returnReason || "",
        r.noCrashSentInReturn ? "true" : "false"
      ].map(v=>{
        const s = String(v ?? "");
        return `"${s.replace(/"/g,'""')}"`;
      });
      lines.push(vals.join(","));
    }
    return lines.join("\n");
  }

  $("btnExportCsv").addEventListener("click", ()=>{
    const rows = sortRows(applyFilters(ALL_ROWS));
    const csv = toCsv(rows);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${ACTIVE_CART}_report_${yyyyMmDd(new Date())}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("CSV exported.");
  });

  // Print
  $("btnPrint").addEventListener("click", ()=> window.print());
  $("btnPrintReport").addEventListener("click", ()=> window.print());

  // Wipe (active cart only)
  $("btnWipe").addEventListener("click", async ()=>{
    const ok = confirm("Wipe ALL data for this tab? This cannot be undone.");
    if(!ok) return;
    try{
      await wipeLogsForActiveCart();
      toast("Wiped.");
    }catch(e){
      console.error(e);
      toast("Save failed because rules.");
    }
  });

  // Init
  (function init(){
    const h = parseHash();
    const cart = (h.cart && ["crashCart","codeBlueBox","anaphylacticCart"].includes(h.cart)) ? h.cart : "crashCart";
    const view = (h.view && ["entry","report"].includes(h.view)) ? h.view : "entry";
    ACTIVE_CART = cart;
    ACTIVE_VIEW = view;

    applyCart(ACTIVE_CART);
    syncSentRequiredUI();

    if(ACTIVE_VIEW === "report") showReport(); else showEntry();
    startFirebaseListener();
  })();
</script>
</body>
</html>
